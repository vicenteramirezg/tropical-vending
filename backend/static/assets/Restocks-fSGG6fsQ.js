import{u as Q,r as f,o as G,c as r,a as e,h as M,t as d,F as I,d as V,i as O,w,v as W,j as E,b as z,f as l,e as R}from"./index-W4rCa7Es.js";import{a as m}from"./api-AtxnuebS.js";const H={key:0,class:"flex justify-center"},J={key:1,class:"bg-red-50 border-l-4 border-red-400 p-4 mb-4"},K={class:"flex"},X={class:"ml-3"},Y={class:"text-sm text-red-700"},Z={key:2,class:"bg-white shadow overflow-hidden sm:rounded-lg"},ee={key:3,class:"bg-white shadow overflow-hidden sm:rounded-lg"},te={role:"list",class:"divide-y divide-gray-200"},se={class:"flex items-center justify-between"},oe={class:"flex-1 min-w-0"},ie={class:"text-sm font-medium text-primary-600 truncate"},ae={class:"text-sm text-gray-500"},ne={class:"ml-4 flex-shrink-0 flex space-x-2"},re=["onClick"],de=["onClick"],le={key:4,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},ce={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},me={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"},ue={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},ve={class:"sm:flex sm:items-start"},pe={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},fe={class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"},ge={class:"mt-4 space-y-4"},xe=["value"],ye={key:0},be={class:"space-y-4"},he={class:"flex justify-between items-center mb-2"},_e={class:"text-sm font-medium text-gray-900"},ke={class:"text-sm text-gray-500"},we={class:"space-y-2"},Re={key:0,class:"text-sm text-gray-500 italic p-2 text-center"},Ce={class:"col-span-1 text-sm font-medium text-gray-900"},Ie={class:"col-span-1"},Ve={class:"mt-1 flex rounded-md shadow-sm"},Ee=["onClick"],De=["onUpdate:modelValue"],Me=["onClick"],Ne={class:"col-span-1"},qe={class:"mt-1 flex rounded-md shadow-sm"},Se=["onClick"],$e=["onUpdate:modelValue"],je=["onClick"],Fe={class:"col-span-1"},Le={class:"mt-1 flex rounded-md shadow-sm"},Pe=["onClick"],Ue=["onUpdate:modelValue"],Ae=["onClick"],Be={class:"col-span-1 text-sm text-gray-500"},Te={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},Qe={key:5,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},Ge={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},Oe={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"},We={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},ze={class:"sm:flex sm:items-start"},He={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},Je={class:"mt-4"},Ke={class:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2"},Xe={class:"sm:col-span-1"},Ye={class:"mt-1 text-sm text-gray-900"},Ze={class:"sm:col-span-1"},et={class:"mt-1 text-sm text-gray-900"},tt={class:"sm:col-span-1"},st={class:"mt-1 text-sm text-gray-900"},ot={class:"sm:col-span-2"},it={class:"mt-1 text-sm text-gray-900"},at={class:"mt-6"},nt={class:"mt-2 border border-gray-200 rounded-md overflow-hidden"},rt={class:"divide-y divide-gray-200"},dt={class:"grid grid-cols-5 gap-2 items-center"},lt={class:"col-span-2 text-sm font-medium text-gray-900"},ct={class:"col-span-1 text-center text-sm text-gray-500"},mt={class:"col-span-1 text-center text-sm text-gray-500"},ut={class:"col-span-1 text-center text-sm text-green-600 font-medium"},vt={class:"col-span-1 text-center text-sm font-medium text-gray-900"},pt={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},yt={__name:"Restocks",setup(ft){const C=Q(),N=f([]),S=f([]),x=f([]),q=f(!0),b=f(null),_=f(!1),D=f(!1),k=f(!1),y=f(null),h=f(""),g=f({id:null,visit_date:"",notes:"",location:"",machines:[]}),$=i=>i?new Date(i).toLocaleString():"",j=async()=>{q.value=!0;try{const i=await m.getVisits();N.value=i.data.map(t=>({id:t.id,location_id:t.location,location_name:t.location_name,visit_date:t.visit_date,notes:t.notes,user_name:t.user_name}))}catch(i){console.error("Error fetching visits:",i),b.value="Failed to load visits. Please try again later."}finally{q.value=!1}},P=async()=>{try{const i=await m.getLocations();S.value=i.data}catch(i){console.error("Error fetching locations:",i)}},F=async()=>{if(!h.value){x.value=[];return}try{const t=(await m.getMachines({location:h.value})).data,u=[];for(const p of t){const c=(await m.getMachineItems({machine:p.id})).data.map(a=>({id:a.product,name:a.product_name,price:a.price,current_stock:a.current_stock||0,stock_before:a.current_stock||0,discarded:0,restocked:0}));u.push({...p,products:c})}x.value=u}catch(i){console.error("Error fetching machines and products:",i),b.value="Failed to load machine products. Please try again."}},L=()=>{k.value=!1,y.value=null,h.value="",x.value=[],g.value={id:null,visit_date:new Date().toISOString().slice(0,16),notes:"",location:"",machines:[]},_.value=!0},U=async i=>{k.value=!0,y.value=i,h.value=i.location_id,g.value={id:i.id,visit_date:i.visit_date,notes:i.notes,location:i.location_id},await F();try{const u=(await m.getRestocks({visit:i.id})).data;for(const p of u){const c=(await m.getRestockEntries({visit_machine_restock:p.id})).data,a=x.value.findIndex(s=>s.id===p.machine);if(a!==-1){const s=x.value[a];c.forEach(o=>{const v=s.products.findIndex(T=>T.id===o.product);v!==-1&&(s.products[v].stock_before=o.stock_before,s.products[v].discarded=o.discarded||0,s.products[v].restocked=o.restocked)})}}_.value=!0}catch(t){console.error("Error loading visit for editing:",t),b.value="Failed to load visit details for editing. Please try again."}},A=async i=>{y.value=i;try{const u=(await m.getRestocks({visit:i.id})).data,p=[];for(const n of u){const c=await m.getRestockEntries({visit_machine_restock:n.id});p.push(...c.data)}y.value={...i,entries:p.map(n=>({id:n.id,product_name:n.product_name,product_id:n.product,previous_quantity:n.stock_before,quantity_discarded:n.discarded,quantity_added:n.restocked,machine_info:n.machine_info}))},D.value=!0}catch(t){console.error("Error fetching visit details:",t),b.value="Failed to load visit details. Please try again."}},B=async()=>{var i;try{if(x.value.some(n=>n.products.some(c=>c.stock_before===""||c.restocked===""))){b.value="Please record stock levels for all products in all machines";return}let u;const p={location:h.value,visit_date:g.value.visit_date,notes:g.value.notes,user:(i=C.user)==null?void 0:i.id};console.log("Saving visit with data:",p),k.value&&g.value.id?u=(await m.updateVisit(g.value.id,p)).data.id:u=(await m.createVisit(p)).data.id;for(const n of x.value){let c;if(k.value)try{const a=await m.getRestocks({visit:u,machine:n.id});if(a.data.length>0){const s=a.data[0],o={visit:u,machine:n.id,notes:s.notes||""};await m.updateRestock(s.id,o),c=s.id}else{const s={visit:u,machine:n.id,notes:""};c=(await m.createRestock(s)).data.id}}catch(a){throw console.error("Error handling machine restock:",a),a}else{const a={visit:u,machine:n.id,notes:""};c=(await m.createRestock(a)).data.id}for(const a of n.products)try{if(k.value){const s=await m.getRestockEntries({visit_machine_restock:c,product:a.id}),o={visit_machine_restock:c,product:a.id,stock_before:parseInt(a.stock_before)||0,discarded:parseInt(a.discarded)||0,restocked:parseInt(a.restocked)||0};s.data.length>0?await m.updateRestockEntry(s.data[0].id,o):await m.createRestockEntry(o)}else{const s={visit_machine_restock:c,product:a.id,stock_before:parseInt(a.stock_before)||0,discarded:parseInt(a.discarded)||0,restocked:parseInt(a.restocked)||0};await m.createRestockEntry(s)}}catch(s){throw console.error("Error handling restock entry:",s),s}}_.value=!1,await j()}catch(t){console.error("Error saving restock visit:",t),b.value="Failed to save visit. Please try again."}};return G(async()=>{C.isAuthenticated&&!C.user&&await C.fetchUser(),console.log("Current user:",C.user),await Promise.all([j(),P()])}),(i,t)=>{var u,p,n,c,a;return l(),r("div",null,[e("div",{class:"flex justify-between items-center mb-6"},[t[7]||(t[7]=e("h1",{class:"text-2xl font-semibold text-gray-900"},"Location Visits",-1)),e("button",{onClick:L,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")]),q.value?(l(),r("div",H,t[8]||(t[8]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"},null,-1)]))):b.value?(l(),r("div",J,[e("div",K,[t[9]||(t[9]=e("div",{class:"flex-shrink-0"},[e("span",{class:"text-red-400"},"âš ")],-1)),e("div",X,[e("p",Y,d(b.value),1)])])])):N.value.length===0?(l(),r("div",Z,[e("div",{class:"px-4 py-5 sm:p-6 text-center"},[t[10]||(t[10]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900"},"No visits recorded",-1)),t[11]||(t[11]=e("div",{class:"mt-2 max-w-xl text-sm text-gray-500"},[e("p",null,"Get started by recording your first location visit.")],-1)),e("div",{class:"mt-5"},[e("button",{onClick:L,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")])])])):(l(),r("div",ee,[e("ul",te,[(l(!0),r(I,null,V(N.value,s=>(l(),r("li",{key:s.id,class:"px-4 py-4 sm:px-6"},[e("div",se,[e("div",oe,[e("p",ie,d(s.location_name),1),e("p",ae,d($(s.visit_date)),1)]),e("div",ne,[e("button",{onClick:o=>A(s),class:"inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," View Details ",8,re),e("button",{onClick:o=>U(s),class:"inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Edit ",8,de)])])]))),128))])])),_.value?(l(),r("div",le,[e("div",ce,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[0]||(t[0]=s=>_.value=!1)}),t[27]||(t[27]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"â€‹",-1)),e("div",me,[e("form",{onSubmit:O(B,["prevent"])},[e("div",ue,[e("div",ve,[e("div",pe,[e("h3",fe,d(k.value?"Edit Visit":"Record New Visit"),1),e("div",ge,[e("div",null,[t[13]||(t[13]=e("label",{for:"location",class:"block text-sm font-medium text-gray-700"},"Location",-1)),w(e("select",{id:"location",name:"location","onUpdate:modelValue":t[1]||(t[1]=s=>h.value=s),onChange:F,class:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md",required:""},[t[12]||(t[12]=e("option",{value:"",disabled:""},"Select a location",-1)),(l(!0),r(I,null,V(S.value,s=>(l(),r("option",{key:s.id,value:s.id},d(s.name),9,xe))),128))],544),[[W,h.value]])]),e("div",null,[t[14]||(t[14]=e("label",{for:"visit_date",class:"block text-sm font-medium text-gray-700"},"Visit Date",-1)),w(e("input",{type:"datetime-local",name:"visit_date",id:"visit_date","onUpdate:modelValue":t[2]||(t[2]=s=>g.value.visit_date=s),class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[E,g.value.visit_date]])]),x.value.length>0?(l(),r("div",ye,[t[24]||(t[24]=e("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Machines at Location",-1)),e("div",be,[(l(!0),r(I,null,V(x.value,s=>(l(),r("div",{key:s.id,class:"border rounded-lg p-4"},[e("div",he,[e("h5",_e,d(s.machine_type)+" ("+d(s.model)+") ",1),e("div",ke,d(s.products.length)+" products ",1)]),e("div",we,[s.products.length===0?(l(),r("div",Re," No products in this machine ")):M("",!0),(l(!0),r(I,null,V(s.products,o=>(l(),r("div",{key:o.id,class:"grid grid-cols-4 gap-4 items-center"},[e("div",Ce,d(o.name),1),e("div",Ie,[t[17]||(t[17]=e("label",{class:"block text-xs text-gray-500"},"Current Stock",-1)),e("div",Ve,[e("button",{type:"button",onClick:v=>o.stock_before=Math.max(0,(parseInt(o.stock_before)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[15]||(t[15]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,Ee),w(e("input",{type:"number","onUpdate:modelValue":v=>o.stock_before=v,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,De),[[E,o.stock_before]]),e("button",{type:"button",onClick:v=>o.stock_before=(parseInt(o.stock_before)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[16]||(t[16]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,Me)])]),e("div",Ne,[t[20]||(t[20]=e("label",{class:"block text-xs text-gray-500"},"Discarded Amount",-1)),e("div",qe,[e("button",{type:"button",onClick:v=>o.discarded=Math.max(0,(parseInt(o.discarded)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[18]||(t[18]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,Se),w(e("input",{type:"number","onUpdate:modelValue":v=>o.discarded=v,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,$e),[[E,o.discarded]]),e("button",{type:"button",onClick:v=>o.discarded=(parseInt(o.discarded)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[19]||(t[19]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,je)])]),e("div",Fe,[t[23]||(t[23]=e("label",{class:"block text-xs text-gray-500"},"Restock Amount",-1)),e("div",Le,[e("button",{type:"button",onClick:v=>o.restocked=Math.max(0,(parseInt(o.restocked)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[21]||(t[21]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,Pe),w(e("input",{type:"number","onUpdate:modelValue":v=>o.restocked=v,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,Ue),[[E,o.restocked]]),e("button",{type:"button",onClick:v=>o.restocked=(parseInt(o.restocked)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[22]||(t[22]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,Ae)])]),e("div",Be," New Total: "+d((parseInt(o.stock_before)||0)-(parseInt(o.discarded)||0)+(parseInt(o.restocked)||0)),1)]))),128))])]))),128))])])):M("",!0),e("div",null,[t[25]||(t[25]=e("label",{for:"notes",class:"block text-sm font-medium text-gray-700"},"Visit Notes",-1)),w(e("textarea",{id:"notes",name:"notes",rows:"2","onUpdate:modelValue":t[3]||(t[3]=s=>g.value.notes=s),class:"shadow-sm focus:ring-primary-500 focus:border-primary-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md"},null,512),[[E,g.value.notes]])])])])])]),e("div",Te,[t[26]||(t[26]=e("button",{type:"submit",class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm"}," Save Visit ",-1)),e("button",{type:"button",onClick:t[4]||(t[4]=s=>_.value=!1),class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Cancel ")])],32)])])])):M("",!0),D.value?(l(),r("div",Qe,[e("div",Ge,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[5]||(t[5]=s=>D.value=!1)}),t[35]||(t[35]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"â€‹",-1)),e("div",Oe,[e("div",We,[e("div",ze,[e("div",He,[t[34]||(t[34]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"}," Restock Details ",-1)),e("div",Je,[e("dl",Ke,[e("div",Xe,[t[28]||(t[28]=e("dt",{class:"text-sm font-medium text-gray-500"},"Location",-1)),e("dd",Ye,d((u=y.value)==null?void 0:u.location_name),1)]),e("div",Ze,[t[29]||(t[29]=e("dt",{class:"text-sm font-medium text-gray-500"},"Visit Date",-1)),e("dd",et,d($((p=y.value)==null?void 0:p.visit_date)),1)]),e("div",tt,[t[30]||(t[30]=e("dt",{class:"text-sm font-medium text-gray-500"},"Restocked By",-1)),e("dd",st,d((n=y.value)==null?void 0:n.user_name),1)]),e("div",ot,[t[31]||(t[31]=e("dt",{class:"text-sm font-medium text-gray-500"},"Notes",-1)),e("dd",it,d(((c=y.value)==null?void 0:c.notes)||"No notes"),1)])]),e("div",at,[t[33]||(t[33]=e("h4",{class:"text-sm font-medium text-gray-500"},"Restocked Items",-1)),e("div",nt,[t[32]||(t[32]=z('<div class="px-4 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider"><div class="grid grid-cols-5 gap-2"><div class="col-span-2">Product</div><div class="col-span-1 text-center">Prev Qty</div><div class="col-span-1 text-center">Discarded</div><div class="col-span-1 text-center">Added</div><div class="col-span-1 text-center">New Qty</div></div></div>',1)),e("div",rt,[(l(!0),r(I,null,V((a=y.value)==null?void 0:a.entries,s=>(l(),r("div",{key:s.id,class:"px-4 py-3"},[e("div",dt,[e("div",lt,d(s.product_name),1),e("div",ct,d(s.previous_quantity),1),e("div",mt,d(s.quantity_discarded),1),e("div",ut," +"+d(s.quantity_added),1),e("div",vt,d(s.previous_quantity+s.quantity_added),1)])]))),128))])])])])])])]),e("div",pt,[e("button",{type:"button",onClick:t[6]||(t[6]=s=>D.value=!1),class:"w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm"}," Close ")])])])])):M("",!0)])}}};export{yt as default};
