import{u as G,r as f,o as O,c as l,a as e,i as q,t as r,F as C,e as V,j as z,w,v as H,k as E,d as J,g as c,f as R}from"./index-Dw_M4SLt.js";import{a as m}from"./api-DuHtRl-A.js";const K={key:0,class:"flex justify-center"},X={key:1,class:"bg-red-50 border-l-4 border-red-400 p-4 mb-4"},Y={class:"flex"},Z={class:"ml-3"},ee={class:"text-sm text-red-700"},te={key:2,class:"bg-white shadow overflow-hidden sm:rounded-lg"},se={key:3,class:"bg-white shadow overflow-hidden sm:rounded-lg"},oe={role:"list",class:"divide-y divide-gray-200"},ie={class:"flex items-center justify-between"},ne={class:"flex-1 min-w-0"},ae={class:"text-sm font-medium text-primary-600 truncate"},re={class:"text-sm text-gray-500"},de={class:"ml-4 flex-shrink-0 flex space-x-2"},le=["onClick"],ce=["onClick"],me={key:4,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},ue={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},pe={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"},ve={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},fe={class:"sm:flex sm:items-start"},ge={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},xe={class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"},ye={class:"mt-4 space-y-4"},be=["value"],he={key:0},_e={class:"space-y-4"},ke={class:"flex justify-between items-center mb-2"},we={class:"text-sm font-medium text-gray-900"},Re={class:"text-sm text-gray-500"},Ie={class:"space-y-2"},Ce={key:0,class:"text-sm text-gray-500 italic p-2 text-center"},Ve={class:"col-span-1 text-sm font-medium text-gray-900 text-center bg-gray-100 rounded-md py-1"},Ee={class:"col-span-3 text-sm font-medium text-gray-900"},De={class:"col-span-2"},Me={class:"mt-1 flex rounded-md shadow-sm"},qe=["onClick"],Ne=["onUpdate:modelValue"],Se=["onClick"],$e={class:"col-span-2"},je={class:"mt-1 flex rounded-md shadow-sm"},Fe=["onClick"],Le=["onUpdate:modelValue"],Pe=["onClick"],Ue={class:"col-span-2"},Ae={class:"mt-1 flex rounded-md shadow-sm"},Be=["onClick"],Te=["onUpdate:modelValue"],Qe=["onClick"],We={class:"col-span-2 text-sm text-gray-500"},Ge={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},Oe={key:5,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},ze={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},He={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"},Je={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},Ke={class:"sm:flex sm:items-start"},Xe={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},Ye={class:"mt-4"},Ze={class:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2"},et={class:"sm:col-span-1"},tt={class:"mt-1 text-sm text-gray-900"},st={class:"sm:col-span-1"},ot={class:"mt-1 text-sm text-gray-900"},it={class:"sm:col-span-1"},nt={class:"mt-1 text-sm text-gray-900"},at={class:"sm:col-span-2"},rt={class:"mt-1 text-sm text-gray-900"},dt={class:"mt-6"},lt={class:"mt-2 border border-gray-200 rounded-md overflow-hidden"},ct={class:"divide-y divide-gray-200"},mt={class:"grid grid-cols-6 gap-2 items-center"},ut={class:"col-span-1 text-center bg-gray-100 rounded-md py-1 text-sm font-medium text-gray-900"},pt={class:"col-span-1 text-sm font-medium text-gray-900"},vt={class:"col-span-1 text-center text-sm text-gray-500"},ft={class:"col-span-1 text-center text-sm text-gray-500"},gt={class:"col-span-1 text-center text-sm text-green-600 font-medium"},xt={class:"col-span-1 text-center text-sm font-medium text-gray-900"},yt={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},kt={__name:"Restocks",setup(bt){const I=G(),N=f([]),$=f([]),x=f([]),S=f(!0),b=f(null),_=f(!1),D=f(!1),k=f(!1),y=f(null),h=f(""),g=f({id:null,visit_date:"",notes:"",location:"",machines:[]}),j=n=>n?new Date(n).toLocaleString():"",F=async()=>{S.value=!0;try{const n=await m.getVisits();N.value=n.data.map(t=>({id:t.id,location_id:t.location,location_name:t.location_name,visit_date:t.visit_date,notes:t.notes,user_name:t.user_name}))}catch(n){console.error("Error fetching visits:",n),b.value="Failed to load visits. Please try again later."}finally{S.value=!1}},A=async()=>{try{const n=await m.getLocations();$.value=n.data}catch(n){console.error("Error fetching locations:",n)}},L=async()=>{if(!h.value){x.value=[];return}try{const t=(await m.getMachines({location:h.value})).data,p=[];for(const v of t){const d=(await m.getMachineItems({machine:v.id})).data.map(i=>({id:i.product,name:i.product_name,price:i.price,slot:i.slot,current_stock:i.current_stock||0,stock_before:i.current_stock||0,discarded:0,restocked:0})).sort((i,s)=>i.slot-s.slot);p.push({...v,products:d})}x.value=p}catch(n){console.error("Error fetching machines and products:",n),b.value="Failed to load machine products. Please try again."}},P=()=>{k.value=!1,y.value=null,h.value="",x.value=[],g.value={id:null,visit_date:new Date().toISOString().slice(0,16),notes:"",location:"",machines:[]},_.value=!0},B=async n=>{k.value=!0,y.value=n,h.value=n.location_id,g.value={id:n.id,visit_date:n.visit_date,notes:n.notes,location:n.location_id},await L();try{const p=(await m.getRestocks({visit:n.id})).data;for(const v of p){const d=(await m.getRestockEntries({visit_machine_restock:v.id})).data,i=x.value.findIndex(s=>s.id===v.machine);if(i!==-1){const s=x.value[i];d.forEach(o=>{const u=s.products.findIndex(M=>M.id===o.product);u!==-1&&(s.products[u].stock_before=o.stock_before,s.products[u].discarded=o.discarded||0,s.products[u].restocked=o.restocked)})}}_.value=!0}catch(t){console.error("Error loading visit for editing:",t),b.value="Failed to load visit details for editing. Please try again."}},T=async n=>{y.value=n;try{const p=(await m.getRestocks({visit:n.id})).data;let v=[];for(const a of p){const i=(await m.getRestockEntries({visit_machine_restock:a.id})).data,o=(await m.getMachineItems({machine:a.machine})).data,u=i.map(M=>{const U=o.find(W=>W.product===M.product);return{...M,slot:U?U.slot:null}});v.push(...u)}v.sort((a,d)=>a.visit_machine_restock!==d.visit_machine_restock?0:(a.slot||999)-(d.slot||999)),y.value={...n,entries:v.map(a=>({id:a.id,product_name:a.product_name,product_id:a.product,previous_quantity:a.stock_before,quantity_discarded:a.discarded,quantity_added:a.restocked,machine_info:a.machine_info,slot:a.slot}))},D.value=!0}catch(t){console.error("Error fetching visit details:",t),b.value="Failed to load visit details. Please try again."}},Q=async()=>{var n;try{if(x.value.some(a=>a.products.some(d=>d.stock_before===""||d.restocked===""))){b.value="Please record stock levels for all products in all machines";return}let p;const v={location:h.value,visit_date:g.value.visit_date,notes:g.value.notes,user:(n=I.user)==null?void 0:n.id};console.log("Saving visit with data:",v),k.value&&g.value.id?p=(await m.updateVisit(g.value.id,v)).data.id:p=(await m.createVisit(v)).data.id;for(const a of x.value){let d;if(k.value)try{const i=await m.getRestocks({visit:p,machine:a.id});if(i.data.length>0){const s=i.data[0],o={visit:p,machine:a.id,notes:s.notes||""};await m.updateRestock(s.id,o),d=s.id}else{const s={visit:p,machine:a.id,notes:""};d=(await m.createRestock(s)).data.id}}catch(i){throw console.error("Error handling machine restock:",i),i}else{const i={visit:p,machine:a.id,notes:""};d=(await m.createRestock(i)).data.id}for(const i of a.products)try{if(k.value){const s=await m.getRestockEntries({visit_machine_restock:d,product:i.id}),o={visit_machine_restock:d,product:i.id,stock_before:parseInt(i.stock_before)||0,discarded:parseInt(i.discarded)||0,restocked:parseInt(i.restocked)||0};s.data.length>0?await m.updateRestockEntry(s.data[0].id,o):await m.createRestockEntry(o)}else{const s={visit_machine_restock:d,product:i.id,stock_before:parseInt(i.stock_before)||0,discarded:parseInt(i.discarded)||0,restocked:parseInt(i.restocked)||0};await m.createRestockEntry(s)}}catch(s){throw console.error("Error handling restock entry:",s),s}}_.value=!1,await F()}catch(t){console.error("Error saving restock visit:",t),b.value="Failed to save visit. Please try again."}};return O(async()=>{I.isAuthenticated&&!I.user&&await I.fetchUser(),console.log("Current user:",I.user),await Promise.all([F(),A()])}),(n,t)=>{var p,v,a,d,i;return c(),l("div",null,[e("div",{class:"flex justify-between items-center mb-6"},[t[7]||(t[7]=e("h1",{class:"text-2xl font-semibold text-gray-900"},"Location Visits",-1)),e("button",{onClick:P,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")]),S.value?(c(),l("div",K,t[8]||(t[8]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"},null,-1)]))):b.value?(c(),l("div",X,[e("div",Y,[t[9]||(t[9]=e("div",{class:"flex-shrink-0"},[e("span",{class:"text-red-400"},"⚠")],-1)),e("div",Z,[e("p",ee,r(b.value),1)])])])):N.value.length===0?(c(),l("div",te,[e("div",{class:"px-4 py-5 sm:p-6 text-center"},[t[10]||(t[10]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900"},"No visits recorded",-1)),t[11]||(t[11]=e("div",{class:"mt-2 max-w-xl text-sm text-gray-500"},[e("p",null,"Get started by recording your first location visit.")],-1)),e("div",{class:"mt-5"},[e("button",{onClick:P,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")])])])):(c(),l("div",se,[e("ul",oe,[(c(!0),l(C,null,V(N.value,s=>(c(),l("li",{key:s.id,class:"px-4 py-4 sm:px-6"},[e("div",ie,[e("div",ne,[e("p",ae,r(s.location_name),1),e("p",re,r(j(s.visit_date)),1)]),e("div",de,[e("button",{onClick:o=>T(s),class:"inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," View Details ",8,le),e("button",{onClick:o=>B(s),class:"inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Edit ",8,ce)])])]))),128))])])),_.value?(c(),l("div",me,[e("div",ue,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[0]||(t[0]=s=>_.value=!1)}),t[27]||(t[27]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"​",-1)),e("div",pe,[e("form",{onSubmit:z(Q,["prevent"])},[e("div",ve,[e("div",fe,[e("div",ge,[e("h3",xe,r(k.value?"Edit Visit":"Record New Visit"),1),e("div",ye,[e("div",null,[t[13]||(t[13]=e("label",{for:"location",class:"block text-sm font-medium text-gray-700"},"Location",-1)),w(e("select",{id:"location",name:"location","onUpdate:modelValue":t[1]||(t[1]=s=>h.value=s),onChange:L,class:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md",required:""},[t[12]||(t[12]=e("option",{value:"",disabled:""},"Select a location",-1)),(c(!0),l(C,null,V($.value,s=>(c(),l("option",{key:s.id,value:s.id},r(s.name),9,be))),128))],544),[[H,h.value]])]),e("div",null,[t[14]||(t[14]=e("label",{for:"visit_date",class:"block text-sm font-medium text-gray-700"},"Visit Date",-1)),w(e("input",{type:"datetime-local",name:"visit_date",id:"visit_date","onUpdate:modelValue":t[2]||(t[2]=s=>g.value.visit_date=s),class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[E,g.value.visit_date]])]),x.value.length>0?(c(),l("div",he,[t[24]||(t[24]=e("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Machines at Location",-1)),e("div",_e,[(c(!0),l(C,null,V(x.value,s=>(c(),l("div",{key:s.id,class:"border rounded-lg p-4"},[e("div",ke,[e("h5",we,r(s.machine_type)+" ("+r(s.model)+") ",1),e("div",Re,r(s.products.length)+" products ",1)]),e("div",Ie,[s.products.length===0?(c(),l("div",Ce," No products in this machine ")):q("",!0),(c(!0),l(C,null,V(s.products,o=>(c(),l("div",{key:o.id,class:"grid grid-cols-12 gap-4 items-center"},[e("div",Ve,r(o.slot),1),e("div",Ee,r(o.name),1),e("div",De,[t[17]||(t[17]=e("label",{class:"block text-xs text-gray-500"},"Current Stock",-1)),e("div",Me,[e("button",{type:"button",onClick:u=>o.stock_before=Math.max(0,(parseInt(o.stock_before)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[15]||(t[15]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,qe),w(e("input",{type:"number","onUpdate:modelValue":u=>o.stock_before=u,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,Ne),[[E,o.stock_before]]),e("button",{type:"button",onClick:u=>o.stock_before=(parseInt(o.stock_before)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[16]||(t[16]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,Se)])]),e("div",$e,[t[20]||(t[20]=e("label",{class:"block text-xs text-gray-500"},"Discarded Amount",-1)),e("div",je,[e("button",{type:"button",onClick:u=>o.discarded=Math.max(0,(parseInt(o.discarded)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[18]||(t[18]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,Fe),w(e("input",{type:"number","onUpdate:modelValue":u=>o.discarded=u,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,Le),[[E,o.discarded]]),e("button",{type:"button",onClick:u=>o.discarded=(parseInt(o.discarded)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[19]||(t[19]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,Pe)])]),e("div",Ue,[t[23]||(t[23]=e("label",{class:"block text-xs text-gray-500"},"Restock Amount",-1)),e("div",Ae,[e("button",{type:"button",onClick:u=>o.restocked=Math.max(0,(parseInt(o.restocked)||0)-1),class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[21]||(t[21]=[e("span",{class:"sr-only"},"Decrease",-1),R(" - ")]),8,Be),w(e("input",{type:"number","onUpdate:modelValue":u=>o.restocked=u,min:"0",class:"focus:ring-primary-500 focus:border-primary-500 block w-full border-gray-300 rounded-none text-center sm:text-sm",required:""},null,8,Te),[[E,o.restocked]]),e("button",{type:"button",onClick:u=>o.restocked=(parseInt(o.restocked)||0)+1,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[22]||(t[22]=[e("span",{class:"sr-only"},"Increase",-1),R(" + ")]),8,Qe)])]),e("div",We," New Total: "+r((parseInt(o.stock_before)||0)-(parseInt(o.discarded)||0)+(parseInt(o.restocked)||0)),1)]))),128))])]))),128))])])):q("",!0),e("div",null,[t[25]||(t[25]=e("label",{for:"notes",class:"block text-sm font-medium text-gray-700"},"Visit Notes",-1)),w(e("textarea",{id:"notes",name:"notes",rows:"2","onUpdate:modelValue":t[3]||(t[3]=s=>g.value.notes=s),class:"shadow-sm focus:ring-primary-500 focus:border-primary-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md"},null,512),[[E,g.value.notes]])])])])])]),e("div",Ge,[t[26]||(t[26]=e("button",{type:"submit",class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm"}," Save Visit ",-1)),e("button",{type:"button",onClick:t[4]||(t[4]=s=>_.value=!1),class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Cancel ")])],32)])])])):q("",!0),D.value?(c(),l("div",Oe,[e("div",ze,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[5]||(t[5]=s=>D.value=!1)}),t[35]||(t[35]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"​",-1)),e("div",He,[e("div",Je,[e("div",Ke,[e("div",Xe,[t[34]||(t[34]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"}," Restock Details ",-1)),e("div",Ye,[e("dl",Ze,[e("div",et,[t[28]||(t[28]=e("dt",{class:"text-sm font-medium text-gray-500"},"Location",-1)),e("dd",tt,r((p=y.value)==null?void 0:p.location_name),1)]),e("div",st,[t[29]||(t[29]=e("dt",{class:"text-sm font-medium text-gray-500"},"Visit Date",-1)),e("dd",ot,r(j((v=y.value)==null?void 0:v.visit_date)),1)]),e("div",it,[t[30]||(t[30]=e("dt",{class:"text-sm font-medium text-gray-500"},"Restocked By",-1)),e("dd",nt,r((a=y.value)==null?void 0:a.user_name),1)]),e("div",at,[t[31]||(t[31]=e("dt",{class:"text-sm font-medium text-gray-500"},"Notes",-1)),e("dd",rt,r(((d=y.value)==null?void 0:d.notes)||"No notes"),1)])]),e("div",dt,[t[33]||(t[33]=e("h4",{class:"text-sm font-medium text-gray-500"},"Restocked Items",-1)),e("div",lt,[t[32]||(t[32]=J('<div class="px-4 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider"><div class="grid grid-cols-6 gap-2"><div class="col-span-1 text-center">Slot</div><div class="col-span-1">Product</div><div class="col-span-1 text-center">Prev Qty</div><div class="col-span-1 text-center">Discarded</div><div class="col-span-1 text-center">Added</div><div class="col-span-1 text-center">New Qty</div></div></div>',1)),e("div",ct,[(c(!0),l(C,null,V((i=y.value)==null?void 0:i.entries,s=>(c(),l("div",{key:s.id,class:"px-4 py-3"},[e("div",mt,[e("div",ut,r(s.slot||"-"),1),e("div",pt,r(s.product_name),1),e("div",vt,r(s.previous_quantity),1),e("div",ft,r(s.quantity_discarded),1),e("div",gt," +"+r(s.quantity_added),1),e("div",xt,r(s.previous_quantity+s.quantity_added-s.quantity_discarded),1)])]))),128))])])])])])])]),e("div",yt,[e("button",{type:"button",onClick:t[6]||(t[6]=s=>D.value=!1),class:"w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm"}," Close ")])])])])):q("",!0)])}}};export{kt as default};
