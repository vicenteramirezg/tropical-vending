import{u as Q,r as p,o as T,c as r,a as e,h as C,t as c,F as R,d as E,i as G,w as V,v as O,j as I,b as W,f as d}from"./index-Co3GJSwP.js";import{a as m}from"./api-BtPiiZ-L.js";const z={key:0,class:"flex justify-center"},H={key:1,class:"bg-red-50 border-l-4 border-red-400 p-4 mb-4"},J={class:"flex"},K={class:"ml-3"},X={class:"text-sm text-red-700"},Y={key:2,class:"bg-white shadow overflow-hidden sm:rounded-lg"},Z={key:3,class:"bg-white shadow overflow-hidden sm:rounded-lg"},ee={role:"list",class:"divide-y divide-gray-200"},te={class:"flex items-center justify-between"},se={class:"flex-1 min-w-0"},oe={class:"text-sm font-medium text-primary-600 truncate"},ie={class:"text-sm text-gray-500"},ae={class:"ml-4 flex-shrink-0 flex space-x-2"},ne=["onClick"],re=["onClick"],de={key:4,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},le={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},ce={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"},me={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},ue={class:"sm:flex sm:items-start"},ve={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},pe={class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"},fe={class:"mt-4 space-y-4"},ge=["value"],xe={key:0},ye={class:"space-y-4"},he={class:"flex justify-between items-center mb-2"},_e={class:"text-sm font-medium text-gray-900"},be={class:"text-sm text-gray-500"},ke={class:"space-y-2"},we={key:0,class:"text-sm text-gray-500 italic p-2 text-center"},Re={class:"col-span-1 text-sm font-medium text-gray-900"},Ee={class:"col-span-1"},Ve=["onUpdate:modelValue"],De={class:"col-span-1"},Ce=["onUpdate:modelValue"],Ie={class:"col-span-1 text-sm text-gray-500"},Me={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},Ne={key:5,class:"fixed inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},Se={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},je={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"},qe={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},Fe={class:"sm:flex sm:items-start"},Le={class:"mt-3 text-center sm:mt-0 sm:text-left w-full"},Pe={class:"mt-4"},Ue={class:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2"},$e={class:"sm:col-span-1"},Ae={class:"mt-1 text-sm text-gray-900"},Be={class:"sm:col-span-1"},Qe={class:"mt-1 text-sm text-gray-900"},Te={class:"sm:col-span-1"},Ge={class:"mt-1 text-sm text-gray-900"},Oe={class:"sm:col-span-2"},We={class:"mt-1 text-sm text-gray-900"},ze={class:"mt-6"},He={class:"mt-2 border border-gray-200 rounded-md overflow-hidden"},Je={class:"divide-y divide-gray-200"},Ke={class:"grid grid-cols-5 gap-2 items-center"},Xe={class:"col-span-2 text-sm font-medium text-gray-900"},Ye={class:"col-span-1 text-center text-sm text-gray-500"},Ze={class:"col-span-1 text-center text-sm text-green-600 font-medium"},et={class:"col-span-1 text-center text-sm font-medium text-gray-900"},tt={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},at={__name:"Restocks",setup(st){const w=Q(),M=p([]),S=p([]),g=p([]),N=p(!0),y=p(null),b=p(!1),D=p(!1),k=p(!1),x=p(null),h=p(""),f=p({id:null,visit_date:"",notes:"",location:"",machines:[]}),j=o=>o?new Date(o).toLocaleString():"",q=async()=>{N.value=!0;try{const o=await m.getVisits();M.value=o.data.map(t=>({id:t.id,location_id:t.location,location_name:t.location_name,visit_date:t.visit_date,notes:t.notes,user_name:t.user_name}))}catch(o){console.error("Error fetching visits:",o),y.value="Failed to load visits. Please try again later."}finally{N.value=!1}},P=async()=>{try{const o=await m.getLocations();S.value=o.data}catch(o){console.error("Error fetching locations:",o)}},F=async()=>{if(!h.value){g.value=[];return}try{const t=(await m.getMachines({location:h.value})).data,u=[];for(const v of t){const l=(await m.getMachineItems({machine:v.id})).data.map(i=>({id:i.product,name:i.product_name,price:i.price,current_stock:i.current_stock||0,stock_before:i.current_stock||0,restocked:0}));u.push({...v,products:l})}g.value=u}catch(o){console.error("Error fetching machines and products:",o),y.value="Failed to load machine products. Please try again."}},L=()=>{k.value=!1,x.value=null,h.value="",g.value=[],f.value={id:null,visit_date:new Date().toISOString().slice(0,16),notes:"",location:"",machines:[]},b.value=!0},U=async o=>{k.value=!0,x.value=o,h.value=o.location_id,f.value={id:o.id,visit_date:o.visit_date,notes:o.notes,location:o.location_id},await F();try{const u=(await m.getRestocks({visit:o.id})).data;for(const v of u){const l=(await m.getRestockEntries({visit_machine_restock:v.id})).data,i=g.value.findIndex(s=>s.id===v.machine);if(i!==-1){const s=g.value[i];l.forEach(n=>{const _=s.products.findIndex(B=>B.id===n.product);_!==-1&&(s.products[_].stock_before=n.stock_before,s.products[_].restocked=n.restocked)})}}b.value=!0}catch(t){console.error("Error loading visit for editing:",t),y.value="Failed to load visit details for editing. Please try again."}},$=async o=>{x.value=o;try{const u=(await m.getRestocks({visit:o.id})).data,v=[];for(const a of u){const l=await m.getRestockEntries({visit_machine_restock:a.id});v.push(...l.data)}x.value={...o,entries:v.map(a=>({id:a.id,product_name:a.product_name,product_id:a.product,previous_quantity:a.stock_before,quantity_added:a.restocked,machine_info:a.machine_info}))},D.value=!0}catch(t){console.error("Error fetching visit details:",t),y.value="Failed to load visit details. Please try again."}},A=async()=>{var o;try{if(g.value.some(a=>a.products.some(l=>l.stock_before===""||l.restocked===""))){y.value="Please record stock levels for all products in all machines";return}let u;const v={location:h.value,visit_date:f.value.visit_date,notes:f.value.notes,user:(o=w.user)==null?void 0:o.id};console.log("Saving visit with data:",v),k.value&&f.value.id?u=(await m.updateVisit(f.value.id,v)).data.id:u=(await m.createVisit(v)).data.id;for(const a of g.value){let l;if(k.value)try{const i=await m.getRestocks({visit:u,machine:a.id});if(i.data.length>0){const s=i.data[0],n={visit:u,machine:a.id,notes:s.notes||""};await m.updateRestock(s.id,n),l=s.id}else{const s={visit:u,machine:a.id,notes:""};l=(await m.createRestock(s)).data.id}}catch(i){throw console.error("Error handling machine restock:",i),i}else{const i={visit:u,machine:a.id,notes:""};l=(await m.createRestock(i)).data.id}for(const i of a.products)try{if(k.value){const s=await m.getRestockEntries({visit_machine_restock:l,product:i.id}),n={visit_machine_restock:l,product:i.id,stock_before:parseInt(i.stock_before)||0,restocked:parseInt(i.restocked)||0};s.data.length>0?await m.updateRestockEntry(s.data[0].id,n):await m.createRestockEntry(n)}else{const s={visit_machine_restock:l,product:i.id,stock_before:parseInt(i.stock_before)||0,restocked:parseInt(i.restocked)||0};await m.createRestockEntry(s)}}catch(s){throw console.error("Error handling restock entry:",s),s}}b.value=!1,await q()}catch(t){console.error("Error saving restock visit:",t),y.value="Failed to save visit. Please try again."}};return T(async()=>{w.isAuthenticated&&!w.user&&await w.fetchUser(),console.log("Current user:",w.user),await Promise.all([q(),P()])}),(o,t)=>{var u,v,a,l,i;return d(),r("div",null,[e("div",{class:"flex justify-between items-center mb-6"},[t[7]||(t[7]=e("h1",{class:"text-2xl font-semibold text-gray-900"},"Location Visits",-1)),e("button",{onClick:L,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")]),N.value?(d(),r("div",z,t[8]||(t[8]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"},null,-1)]))):y.value?(d(),r("div",H,[e("div",J,[t[9]||(t[9]=e("div",{class:"flex-shrink-0"},[e("span",{class:"text-red-400"},"⚠")],-1)),e("div",K,[e("p",X,c(y.value),1)])])])):M.value.length===0?(d(),r("div",Y,[e("div",{class:"px-4 py-5 sm:p-6 text-center"},[t[10]||(t[10]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900"},"No visits recorded",-1)),t[11]||(t[11]=e("div",{class:"mt-2 max-w-xl text-sm text-gray-500"},[e("p",null,"Get started by recording your first location visit.")],-1)),e("div",{class:"mt-5"},[e("button",{onClick:L,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Record New Visit ")])])])):(d(),r("div",Z,[e("ul",ee,[(d(!0),r(R,null,E(M.value,s=>(d(),r("li",{key:s.id,class:"px-4 py-4 sm:px-6"},[e("div",te,[e("div",se,[e("p",oe,c(s.location_name),1),e("p",ie,c(j(s.visit_date)),1)]),e("div",ae,[e("button",{onClick:n=>$(s),class:"inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," View Details ",8,ne),e("button",{onClick:n=>U(s),class:"inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"}," Edit ",8,re)])])]))),128))])])),b.value?(d(),r("div",de,[e("div",le,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[0]||(t[0]=s=>b.value=!1)}),t[20]||(t[20]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"​",-1)),e("div",ce,[e("form",{onSubmit:G(A,["prevent"])},[e("div",me,[e("div",ue,[e("div",ve,[e("h3",pe,c(k.value?"Edit Visit":"Record New Visit"),1),e("div",fe,[e("div",null,[t[13]||(t[13]=e("label",{for:"location",class:"block text-sm font-medium text-gray-700"},"Location",-1)),V(e("select",{id:"location",name:"location","onUpdate:modelValue":t[1]||(t[1]=s=>h.value=s),onChange:F,class:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md",required:""},[t[12]||(t[12]=e("option",{value:"",disabled:""},"Select a location",-1)),(d(!0),r(R,null,E(S.value,s=>(d(),r("option",{key:s.id,value:s.id},c(s.name),9,ge))),128))],544),[[O,h.value]])]),e("div",null,[t[14]||(t[14]=e("label",{for:"visit_date",class:"block text-sm font-medium text-gray-700"},"Visit Date",-1)),V(e("input",{type:"datetime-local",name:"visit_date",id:"visit_date","onUpdate:modelValue":t[2]||(t[2]=s=>f.value.visit_date=s),class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[I,f.value.visit_date]])]),g.value.length>0?(d(),r("div",xe,[t[17]||(t[17]=e("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Machines at Location",-1)),e("div",ye,[(d(!0),r(R,null,E(g.value,s=>(d(),r("div",{key:s.id,class:"border rounded-lg p-4"},[e("div",he,[e("h5",_e,c(s.machine_type)+" ("+c(s.model)+") ",1),e("div",be,c(s.products.length)+" products ",1)]),e("div",ke,[s.products.length===0?(d(),r("div",we," No products in this machine ")):C("",!0),(d(!0),r(R,null,E(s.products,n=>(d(),r("div",{key:n.id,class:"grid grid-cols-4 gap-4 items-center"},[e("div",Re,c(n.name),1),e("div",Ee,[t[15]||(t[15]=e("label",{class:"block text-xs text-gray-500"},"Current Stock",-1)),V(e("input",{type:"number","onUpdate:modelValue":_=>n.stock_before=_,min:"0",class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm",required:""},null,8,Ve),[[I,n.stock_before]])]),e("div",De,[t[16]||(t[16]=e("label",{class:"block text-xs text-gray-500"},"Restock Amount",-1)),V(e("input",{type:"number","onUpdate:modelValue":_=>n.restocked=_,min:"0",class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm",required:""},null,8,Ce),[[I,n.restocked]])]),e("div",Ie," New Total: "+c((parseInt(n.stock_before)||0)+(parseInt(n.restocked)||0)),1)]))),128))])]))),128))])])):C("",!0),e("div",null,[t[18]||(t[18]=e("label",{for:"notes",class:"block text-sm font-medium text-gray-700"},"Visit Notes",-1)),V(e("textarea",{id:"notes",name:"notes",rows:"2","onUpdate:modelValue":t[3]||(t[3]=s=>f.value.notes=s),class:"shadow-sm focus:ring-primary-500 focus:border-primary-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md"},null,512),[[I,f.value.notes]])])])])])]),e("div",Me,[t[19]||(t[19]=e("button",{type:"submit",class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm"}," Save Visit ",-1)),e("button",{type:"button",onClick:t[4]||(t[4]=s=>b.value=!1),class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Cancel ")])],32)])])])):C("",!0),D.value?(d(),r("div",Ne,[e("div",Se,[e("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:t[5]||(t[5]=s=>D.value=!1)}),t[28]||(t[28]=e("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"​",-1)),e("div",je,[e("div",qe,[e("div",Fe,[e("div",Le,[t[27]||(t[27]=e("h3",{class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"}," Restock Details ",-1)),e("div",Pe,[e("dl",Ue,[e("div",$e,[t[21]||(t[21]=e("dt",{class:"text-sm font-medium text-gray-500"},"Location",-1)),e("dd",Ae,c((u=x.value)==null?void 0:u.location_name),1)]),e("div",Be,[t[22]||(t[22]=e("dt",{class:"text-sm font-medium text-gray-500"},"Visit Date",-1)),e("dd",Qe,c(j((v=x.value)==null?void 0:v.visit_date)),1)]),e("div",Te,[t[23]||(t[23]=e("dt",{class:"text-sm font-medium text-gray-500"},"Restocked By",-1)),e("dd",Ge,c((a=x.value)==null?void 0:a.user_name),1)]),e("div",Oe,[t[24]||(t[24]=e("dt",{class:"text-sm font-medium text-gray-500"},"Notes",-1)),e("dd",We,c(((l=x.value)==null?void 0:l.notes)||"No notes"),1)])]),e("div",ze,[t[26]||(t[26]=e("h4",{class:"text-sm font-medium text-gray-500"},"Restocked Items",-1)),e("div",He,[t[25]||(t[25]=W('<div class="px-4 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider"><div class="grid grid-cols-5 gap-2"><div class="col-span-2">Product</div><div class="col-span-1 text-center">Prev Qty</div><div class="col-span-1 text-center">Added</div><div class="col-span-1 text-center">New Qty</div></div></div>',1)),e("div",Je,[(d(!0),r(R,null,E((i=x.value)==null?void 0:i.entries,s=>(d(),r("div",{key:s.id,class:"px-4 py-3"},[e("div",Ke,[e("div",Xe,c(s.product_name),1),e("div",Ye,c(s.previous_quantity),1),e("div",Ze," +"+c(s.quantity_added),1),e("div",et,c(s.previous_quantity+s.quantity_added),1)])]))),128))])])])])])])]),e("div",tt,[e("button",{type:"button",onClick:t[6]||(t[6]=s=>D.value=!1),class:"w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm"}," Close ")])])])])):C("",!0)])}}};export{at as default};
