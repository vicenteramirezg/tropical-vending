<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        input {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .warning {
            background-color: #ffe8cc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>API Debug Tool</h1>
    
    <div class="section">
        <h2>0. Database Status & Migrations</h2>
        <button id="checkDbBtn">Check Database Tables</button>
        <div id="dbResult"></div>
        
        <div class="warning">
            <strong>Warning:</strong> Running migrations will modify your database. Only use if you know what you're doing.
        </div>
        <div>
            <label for="migrationSecret">Secret Key (First 8 chars):</label>
            <input type="password" id="migrationSecret" placeholder="Required for security">
        </div>
        <button id="runMigrationsBtn">Run Database Migrations</button>
        <div id="migrationsResult"></div>
    </div>
    
    <div class="section">
        <h2>1. Test API Connection</h2>
        <button id="testApiBtn">Test API Connection</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="section">
        <h2>2. Authentication Tests</h2>
        <div>
            <label for="username">Username:</label>
            <input type="text" id="username" value="vicente">
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" id="password" value="186422775">
        </div>
        <button id="testAuthBtn">Test Direct Authentication</button>
        <div id="authResult"></div>
        
        <h3>Direct Authentication Test</h3>
        <button id="directAuthBtn">Test Direct Auth Endpoint</button>
        <div id="directAuthResult"></div>
        
        <h3>JWT Token Test</h3>
        <button id="loginBtn">Test JWT Login</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="section">
        <h2>3. User Details</h2>
        <button id="checkUserBtn">Check User Existence</button>
        <div id="userResult"></div>
    </div>
    
    <div class="section">
        <h2>4. Environment Information</h2>
        <pre id="envInfo"></pre>
    </div>

    <script>
        // Display environment info
        document.getElementById('envInfo').textContent = `
            Window Location: ${window.location.href}
            Host: ${window.location.host}
            Protocol: ${window.location.protocol}
            User Agent: ${navigator.userAgent}
        `;

        // Check database
        document.getElementById('checkDbBtn').addEventListener('click', async () => {
            const dbResult = document.getElementById('dbResult');
            dbResult.innerHTML = 'Checking database tables...';
            
            try {
                const response = await fetch('/api/debug/');
                const data = await response.json();
                
                dbResult.innerHTML = `
                    <h4>Database Tables:</h4>
                    <pre>${JSON.stringify(data.database, null, 2)}</pre>
                `;
            } catch (error) {
                dbResult.innerHTML = `
                    <p class="error">Database check failed: ${error.message}</p>
                `;
                console.error('Database check error:', error);
            }
        });

        // Run migrations
        document.getElementById('runMigrationsBtn').addEventListener('click', async () => {
            const migrationsResult = document.getElementById('migrationsResult');
            const secret = document.getElementById('migrationSecret').value;
            
            if (!secret) {
                migrationsResult.innerHTML = `
                    <p class="error">Secret key is required</p>
                `;
                return;
            }
            
            migrationsResult.innerHTML = 'Running migrations...';
            
            try {
                const response = await fetch(`/api/run-migrations/?secret=${encodeURIComponent(secret)}`);
                const data = await response.json();
                
                if (response.ok) {
                    migrationsResult.innerHTML = `
                        <p class="success">Migrations completed</p>
                        <pre>${data.output}</pre>
                        <p>Database Status: ${JSON.stringify(data.database)}</p>
                    `;
                } else {
                    migrationsResult.innerHTML = `
                        <p class="error">Migration failed: ${data.message}</p>
                        <pre>${data.output || ''}</pre>
                    `;
                }
            } catch (error) {
                migrationsResult.innerHTML = `
                    <p class="error">Migration request failed: ${error.message}</p>
                `;
                console.error('Migration error:', error);
            }
        });

        // Test API connection
        document.getElementById('testApiBtn').addEventListener('click', async () => {
            const apiResult = document.getElementById('apiResult');
            apiResult.innerHTML = 'Testing connection...';
            
            try {
                // Use relative URL to test connection
                const response = await fetch('/api/debug/');
                const data = await response.json();
                
                apiResult.innerHTML = `
                    <p class="success">Connection successful!</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                apiResult.innerHTML = `
                    <p class="error">Connection failed: ${error.message}</p>
                `;
                console.error('API connection error:', error);
            }
        });

        // Test direct authentication
        document.getElementById('testAuthBtn').addEventListener('click', async () => {
            const authResult = document.getElementById('authResult');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            authResult.innerHTML = 'Testing authentication...';
            
            try {
                const response = await fetch('/api/debug/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                authResult.innerHTML = `
                    <pre>${JSON.stringify(data.user_debug, null, 2)}</pre>
                `;
            } catch (error) {
                authResult.innerHTML = `
                    <p class="error">Authentication test failed: ${error.message}</p>
                `;
                console.error('Auth test error:', error);
            }
        });

        // Add the direct auth test handler
        document.getElementById('directAuthBtn').addEventListener('click', async () => {
            const directAuthResult = document.getElementById('directAuthResult');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            directAuthResult.innerHTML = 'Testing direct authentication endpoint...';
            
            try {
                const response = await fetch('/api/direct-auth/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                directAuthResult.innerHTML = `
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                directAuthResult.innerHTML = `
                    <p class="error">Direct authentication test failed: ${error.message}</p>
                `;
                console.error('Direct auth test error:', error);
            }
        });

        // Test JWT login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const loginResult = document.getElementById('loginResult');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            loginResult.innerHTML = 'Testing JWT login...';
            
            try {
                const response = await fetch('/api/token/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loginResult.innerHTML = `
                        <p class="success">Login successful!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    loginResult.innerHTML = `
                        <p class="error">Login failed</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                loginResult.innerHTML = `
                    <p class="error">Login request failed: ${error.message}</p>
                `;
                console.error('Login error:', error);
            }
        });

        // Check user existence
        document.getElementById('checkUserBtn').addEventListener('click', async () => {
            const userResult = document.getElementById('userResult');
            userResult.innerHTML = 'Checking user...';
            
            try {
                const response = await fetch('/api/debug/');
                const data = await response.json();
                
                userResult.innerHTML = `
                    <pre>${JSON.stringify(data.user_debug, null, 2)}</pre>
                `;
            } catch (error) {
                userResult.innerHTML = `
                    <p class="error">User check failed: ${error.message}</p>
                `;
                console.error('User check error:', error);
            }
        });
    </script>
</body>
</html>
